#!/usr/bin/env ruby
# frozen_string_literal: true

require 'kstor'

KStor::Log.reporting_level = Journald::LOG_DEBUG

config = KStor::Config.load(ARGV.shift)

store = KStor::Store.new(config.database)
session_store = KStor::SessionStore.new(
  config.session_idle_timeout,
  config.session_life_timeout
)
request_handler = KStor::Controller::RequestHandler.new(store, session_store)

server = KStor::Server.new(
  controller: request_handler,
  socket_path: config.socket,
  nworkers: config.nworkers
)

me = File.basename($PROGRAM_NAME)
Process.setproctitle(me)

server.start
