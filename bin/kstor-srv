#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'kstor/config'
require 'kstor/store'
require 'kstor/controller'
require 'kstor/server'
require 'kstor/log'
require 'kstor/session'

KStor::Log.reporting_level = Journald::LOG_DEBUG

config = KStor::Config.load(ARGV.shift)

store = KStor::Store.new(config.database)
session_store = KStor::SessionStore.new(
  config.session_idle_timeout,
  config.session_life_timeout
)
server = KStor::Server.new(
  controller: KStor::Controller.new(store, session_store),
  socket_path: config.socket,
  nworkers: config.nworkers
)

me = File.basename($PROGRAM_NAME)
Process.setproctitle(me)

server.start
